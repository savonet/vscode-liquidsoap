># A library to store the metadata of files in given folders and query them. This
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># is useful to generate playlists based on metadata.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @category File
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^ source.liquidsoap comment.line.number-sign.liquidsoap
#  ^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap comment.doc.category.liquidsoap
#           ^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @param ~persistency Store the database in given file, which is reuse to populate the database on next run.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^ source.liquidsoap comment.line.number-sign.liquidsoap
#  ^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap comment.doc.param.liquidsoap
#        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @param ~refresh Scan directories for new files every given number of seconds (by default the database is never updated).
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^ source.liquidsoap comment.line.number-sign.liquidsoap
#  ^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap comment.doc.param.liquidsoap
#        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @param ~standardize Function mapped on metadata when indexing. It can be used to change the field names to standard ones, pretreat data, etc.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^ source.liquidsoap comment.line.number-sign.liquidsoap
#  ^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap comment.doc.param.liquidsoap
#        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @param ~initial_progress Show progress of library being indexed at startup.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^ source.liquidsoap comment.line.number-sign.liquidsoap
#  ^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap comment.doc.param.liquidsoap
#        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @param ~directories Directories to look for files in.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^ source.liquidsoap comment.line.number-sign.liquidsoap
#  ^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap comment.doc.param.liquidsoap
#        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @param dir Directory to look for files in.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^ source.liquidsoap comment.line.number-sign.liquidsoap
#  ^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap comment.doc.param.liquidsoap
#        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @method find Find files according to conditions on metadata.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @method refresh Update metadatas and look for new files.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @method add_directory Add a new directory which should be scanned.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
># @method clear Remove all known metadata.
#^ source.liquidsoap comment.line.number-sign.liquidsoap
# ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>def medialib(~id=null(), ~persistency=null(), ~refresh=null(), ~standardize=fun(m)->m, ~initial_progress=true, ~directories=[], dir=null())
#^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#   ^ source.liquidsoap
#    ^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#            ^ source.liquidsoap
#             ^ source.liquidsoap
#              ^^ source.liquidsoap variable.parameter.liquidsoap
#                ^ source.liquidsoap
#                 ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap
#                       ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                        ^ source.liquidsoap
#                         ^ source.liquidsoap
#                          ^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                     ^ source.liquidsoap
#                                      ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                            ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                             ^ source.liquidsoap
#                                              ^ source.liquidsoap
#                                               ^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                      ^ source.liquidsoap
#                                                       ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                                             ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                              ^ source.liquidsoap
#                                                               ^ source.liquidsoap
#                                                                ^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                           ^ source.liquidsoap
#                                                                            ^^^ source.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                                                                               ^ source.liquidsoap
#                                                                                ^ source.liquidsoap variable.liquidsoap
#                                                                                 ^ source.liquidsoap
#                                                                                  ^^ source.liquidsoap keyword.control.function.declaration.liquidsoap
#                                                                                    ^ source.liquidsoap variable.liquidsoap
#                                                                                     ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                      ^ source.liquidsoap
#                                                                                       ^ source.liquidsoap
#                                                                                        ^^^^^^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                        ^ source.liquidsoap
#                                                                                                         ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                                                                             ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                              ^ source.liquidsoap
#                                                                                                               ^ source.liquidsoap
#                                                                                                                ^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                           ^^^ source.liquidsoap
#                                                                                                                              ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                               ^ source.liquidsoap
#                                                                                                                                ^^^ source.liquidsoap variable.liquidsoap
#                                                                                                                                   ^ source.liquidsoap
#                                                                                                                                    ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                         ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                          ^ source.liquidsoap
>  id = string.id.default(default="medialib", id)
#^^ source.liquidsoap
#  ^^ source.liquidsoap entity.name.function.binding.liquidsoap
#    ^^ source.liquidsoap
#      ^ source.liquidsoap
#       ^^^^^^ source.liquidsoap variable.liquidsoap
#             ^ source.liquidsoap keyword.other.liquidsoap
#              ^^ source.liquidsoap variable.method.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap
#                 ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap
#                         ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                  ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                             ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                               ^ source.liquidsoap meta.function-call.liquidsoap
>  refresh_time = refresh
#^^ source.liquidsoap
#  ^^^^^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#              ^^ source.liquidsoap
#                ^ source.liquidsoap
#                 ^^^^^^^ source.liquidsoap variable.liquidsoap
>  directories = ref(directories)
#^^ source.liquidsoap
#  ^^^^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#             ^^ source.liquidsoap
#               ^ source.liquidsoap
#                ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap
>  if null.defined(dir) then directories := null.get(dir) :: directories() end
#^^ source.liquidsoap
#  ^^ source.liquidsoap keyword.control.liquidsoap
#    ^ source.liquidsoap
#     ^^^^ source.liquidsoap variable.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap
#                  ^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^ source.liquidsoap
#                       ^^^^ source.liquidsoap keyword.control.liquidsoap
#                           ^ source.liquidsoap
#                            ^^^^^^^^^^^ source.liquidsoap variable.liquidsoap
#                                       ^ source.liquidsoap
#                                        ^^ source.liquidsoap keyword.operator.set.liquidsoap
#                                          ^ source.liquidsoap
#                                           ^^^^ source.liquidsoap variable.liquidsoap
#                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                                    ^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                       ^ source.liquidsoap meta.function-call.liquidsoap
#                                                        ^ source.liquidsoap
#                                                         ^^ source.liquidsoap keyword.operator.append.liquidsoap
#                                                           ^ source.liquidsoap
#                                                            ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                       ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                         ^ source.liquidsoap
#                                                                          ^^^ source.liquidsoap keyword.control.liquidsoap
>
>  db = ref([])
#^^ source.liquidsoap
#  ^^ source.liquidsoap entity.name.function.binding.liquidsoap
#    ^^ source.liquidsoap
#      ^ source.liquidsoap
#       ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap
#           ^^ source.liquidsoap meta.function-call.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
>
>  def dt(t) = string.float(decimal_places=2,time()-t) end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^ source.liquidsoap entity.name.function.binding.liquidsoap
#        ^ source.liquidsoap
#         ^ source.liquidsoap variable.liquidsoap
#          ^ source.liquidsoap
#           ^^ source.liquidsoap
#             ^ source.liquidsoap
#              ^^^^^^ source.liquidsoap variable.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap
#                     ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
#                           ^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                         ^ source.liquidsoap meta.function-call.liquidsoap
#                                          ^ source.liquidsoap meta.function-call.liquidsoap constant.numeric.decimal.integer.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                            ^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                 ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                  ^ source.liquidsoap meta.function-call.liquidsoap keyword.operator.arithmetic.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap
#                                                     ^ source.liquidsoap
#                                                      ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  # Read metadata from file.
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  def metadata(f)
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#              ^ source.liquidsoap
#               ^ source.liquidsoap variable.liquidsoap
#                ^ source.liquidsoap
>    m = file.metadata.native(f)
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^^ source.liquidsoap variable.liquidsoap
#            ^ source.liquidsoap keyword.other.liquidsoap
#             ^^^^^^^^ source.liquidsoap variable.method.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                            ^ source.liquidsoap meta.function-call.liquidsoap
#                             ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap
>    m = standardize(m)
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
>    # Sanitize
#^^^^ source.liquidsoap
#    ^ source.liquidsoap comment.line.number-sign.liquidsoap
#     ^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>    m = metadata.cover.remove(m)
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^^^^^^ source.liquidsoap variable.liquidsoap
#                ^ source.liquidsoap keyword.other.liquidsoap
#                 ^^^^^ source.liquidsoap variable.method.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap
#                       ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                             ^ source.liquidsoap meta.function-call.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap
>    m = list.assoc.filter(fun (k,_) -> not list.mem(k, ["priv","rva2"]), m)
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^^ source.liquidsoap variable.liquidsoap
#            ^ source.liquidsoap keyword.other.liquidsoap
#             ^^^^^ source.liquidsoap variable.method.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap
#                          ^^^ source.liquidsoap meta.function-call.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                             ^^ source.liquidsoap meta.function-call.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                 ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^^ source.liquidsoap meta.function-call.liquidsoap keyword.control.function.declaration.liquidsoap
#                                      ^ source.liquidsoap meta.function-call.liquidsoap
#                                       ^^^ source.liquidsoap meta.function-call.liquidsoap keyword.operator.boolean.liquidsoap
#                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                           ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                               ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                ^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                     ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                      ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                        ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                         ^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                             ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                              ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                               ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                ^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                    ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                     ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                      ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                       ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                         ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                          ^ source.liquidsoap meta.function-call.liquidsoap
>    # Add more metadata
#^^^^ source.liquidsoap
#    ^ source.liquidsoap comment.line.number-sign.liquidsoap
#     ^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>    m = ("basename",path.basename(f)) :: m
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^^ source.liquidsoap
#         ^ source.liquidsoap string.quoted.double.liquidsoap
#          ^^^^^^^^ source.liquidsoap string.quoted.double.liquidsoap
#                  ^ source.liquidsoap string.quoted.double.liquidsoap
#                   ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                    ^^^^ source.liquidsoap variable.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap
#                         ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^^ source.liquidsoap
#                                      ^^ source.liquidsoap keyword.operator.append.liquidsoap
#                                        ^ source.liquidsoap
#                                         ^ source.liquidsoap variable.liquidsoap
>    m = ("last scan",string.float(time())) :: m
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^^ source.liquidsoap
#         ^ source.liquidsoap string.quoted.double.liquidsoap
#          ^^^^^^^^^ source.liquidsoap string.quoted.double.liquidsoap
#                   ^ source.liquidsoap string.quoted.double.liquidsoap
#                    ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                     ^^^^^^ source.liquidsoap variable.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap
#                            ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                  ^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                      ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                       ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                         ^^ source.liquidsoap
#                                           ^^ source.liquidsoap keyword.operator.append.liquidsoap
#                                             ^ source.liquidsoap
#                                              ^ source.liquidsoap variable.liquidsoap
>    m
#^^^^ source.liquidsoap
#    ^ source.liquidsoap variable.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  # Whether an entry needs ot be updated.
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  def needs_update(f,m)
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#                  ^ source.liquidsoap
#                   ^ source.liquidsoap variable.liquidsoap
#                    ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                     ^ source.liquidsoap variable.liquidsoap
#                      ^ source.liquidsoap
>    file.mtime(f) > string.to_float(m["last scan"])
#^^^^ source.liquidsoap
#    ^^^^ source.liquidsoap variable.liquidsoap
#        ^ source.liquidsoap meta.function-call.liquidsoap
#         ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap
#                 ^ source.liquidsoap
#                  ^ source.liquidsoap keyword.operator.compare.liquidsoap
#                   ^ source.liquidsoap
#                    ^^^^^^ source.liquidsoap variable.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
#                           ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                     ^ source.liquidsoap meta.function-call.liquidsoap
#                                      ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                       ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                                  ^ source.liquidsoap meta.function-call.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  # Add a file to the database.
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  def add(f)
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#         ^ source.liquidsoap
#          ^ source.liquidsoap variable.liquidsoap
#           ^ source.liquidsoap
>    # If file doesn't exist remove it
#^^^^ source.liquidsoap
#    ^ source.liquidsoap comment.line.number-sign.liquidsoap
#     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>    if not (file.exists(f)) then
#^^^^ source.liquidsoap
#    ^^ source.liquidsoap keyword.control.liquidsoap
#      ^ source.liquidsoap
#       ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#          ^^ source.liquidsoap meta.function-call.liquidsoap
#            ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                 ^^^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
#                           ^ source.liquidsoap
#                            ^^^^ source.liquidsoap keyword.control.liquidsoap
>      db := list.assoc.remove(f, db())
#^^^^^^ source.liquidsoap
#      ^^ source.liquidsoap variable.liquidsoap
#        ^ source.liquidsoap
#         ^^ source.liquidsoap keyword.operator.set.liquidsoap
#           ^ source.liquidsoap
#            ^^^^ source.liquidsoap variable.liquidsoap
#                ^ source.liquidsoap keyword.other.liquidsoap
#                 ^^^^^ source.liquidsoap variable.method.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap
#                       ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                             ^ source.liquidsoap meta.function-call.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                 ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                    ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                     ^ source.liquidsoap meta.function-call.liquidsoap
>    else
#^^^^ source.liquidsoap
#    ^^^^ source.liquidsoap keyword.control.liquidsoap
>      # New file or not recent enough metadata
#^^^^^^ source.liquidsoap
#      ^ source.liquidsoap comment.line.number-sign.liquidsoap
#       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>      if not list.assoc.mem(f,db()) or needs_update(f,list.assoc(f,db())) then
#^^^^^^ source.liquidsoap
#      ^^ source.liquidsoap keyword.control.liquidsoap
#        ^ source.liquidsoap
#         ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
#            ^ source.liquidsoap
#             ^^^^ source.liquidsoap variable.liquidsoap
#                 ^ source.liquidsoap keyword.other.liquidsoap
#                  ^^^^^ source.liquidsoap variable.method.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap
#                            ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                             ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                              ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap
#                                   ^ source.liquidsoap
#                                    ^^ source.liquidsoap keyword.operator.boolean.liquidsoap
#                                      ^ source.liquidsoap
#                                       ^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                     ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                      ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                          ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                           ^^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                 ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                  ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                   ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                     ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                      ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                       ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                         ^ source.liquidsoap
#                                                                          ^^^^ source.liquidsoap keyword.control.liquidsoap
>        db := (f,metadata(f)) :: list.assoc.remove(f,db())
#^^^^^^^^ source.liquidsoap
#        ^^ source.liquidsoap variable.liquidsoap
#          ^ source.liquidsoap
#           ^^ source.liquidsoap keyword.operator.set.liquidsoap
#             ^^ source.liquidsoap
#               ^ source.liquidsoap variable.liquidsoap
#                ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                 ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap
#                            ^^ source.liquidsoap
#                              ^^ source.liquidsoap keyword.operator.append.liquidsoap
#                                ^ source.liquidsoap
#                                 ^^^^ source.liquidsoap variable.liquidsoap
#                                     ^ source.liquidsoap keyword.other.liquidsoap
#                                      ^^^^^ source.liquidsoap variable.method.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                            ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                  ^ source.liquidsoap meta.function-call.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                     ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                       ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                        ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                         ^ source.liquidsoap meta.function-call.liquidsoap
>      end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.control.liquidsoap
>    end
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap keyword.control.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  # Update database by renewing metadata and removing removed files.
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  def update(~progress=fun(_,_)->())
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#            ^ source.liquidsoap
#             ^ source.liquidsoap
#              ^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                      ^ source.liquidsoap
#                       ^^^ source.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                          ^ source.liquidsoap
#                           ^ source.liquidsoap variable.liquidsoap
#                            ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                             ^ source.liquidsoap variable.liquidsoap
#                              ^ source.liquidsoap
#                               ^^ source.liquidsoap keyword.control.function.declaration.liquidsoap
#                                 ^ source.liquidsoap
#                                  ^ source.liquidsoap
#                                   ^ source.liquidsoap
>    len = list.length(db())
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#       ^^ source.liquidsoap
#         ^ source.liquidsoap
#          ^^^^ source.liquidsoap variable.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
>    n = ref(0)
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap constant.numeric.decimal.integer.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
>    nu = ref(0)
#^^^^ source.liquidsoap
#    ^^ source.liquidsoap entity.name.function.binding.liquidsoap
#      ^^ source.liquidsoap
#        ^ source.liquidsoap
#         ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap constant.numeric.decimal.integer.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
>    def u(fm)
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#       ^ source.liquidsoap
#        ^ source.liquidsoap entity.name.function.binding.liquidsoap
#         ^ source.liquidsoap
#          ^^ source.liquidsoap variable.liquidsoap
#            ^ source.liquidsoap
>      let (f,m) = fm
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.other.function.declaration.pattern.liquidsoap
#         ^^ source.liquidsoap
#           ^ source.liquidsoap entity.name.function.binding.liquidsoap
#            ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#             ^ source.liquidsoap entity.name.function.binding.liquidsoap
#              ^ source.liquidsoap
#               ^^^ source.liquidsoap
#                  ^^ source.liquidsoap variable.liquidsoap
>      ref.incr(n)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap variable.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap
>      progress(n(),len)
#^^^^^^ source.liquidsoap
#      ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                   ^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap
>      if not (file.exists(f)) then
#^^^^^^ source.liquidsoap
#      ^^ source.liquidsoap keyword.control.liquidsoap
#        ^ source.liquidsoap
#         ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#            ^^ source.liquidsoap meta.function-call.liquidsoap
#              ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                   ^^^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                            ^ source.liquidsoap meta.function-call.liquidsoap
#                             ^ source.liquidsoap
#                              ^^^^ source.liquidsoap keyword.control.liquidsoap
>        null()
#^^^^^^^^ source.liquidsoap
#        ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
>      elsif needs_update(f,m) then
#^^^^^^ source.liquidsoap
#      ^^^^^ source.liquidsoap keyword.control.liquidsoap
#           ^ source.liquidsoap
#            ^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                           ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                            ^ source.liquidsoap meta.function-call.liquidsoap
#                             ^ source.liquidsoap
#                              ^^^^ source.liquidsoap keyword.control.liquidsoap
>        ref.incr(nu)
#^^^^^^^^ source.liquidsoap
#        ^^^ source.liquidsoap variable.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
#            ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap
#                 ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap
>        (f,metadata(f))
#^^^^^^^^^ source.liquidsoap
#         ^ source.liquidsoap variable.liquidsoap
#          ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#           ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^ source.liquidsoap
>      else
#^^^^^^ source.liquidsoap
#      ^^^^ source.liquidsoap keyword.control.liquidsoap
>        (f,m)
#^^^^^^^^^ source.liquidsoap
#         ^ source.liquidsoap variable.liquidsoap
#          ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#           ^ source.liquidsoap variable.liquidsoap
#            ^^ source.liquidsoap
>      end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.control.liquidsoap
>    end
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>    db := list.filter_map(u,db())
#^^^^ source.liquidsoap
#    ^^ source.liquidsoap variable.liquidsoap
#      ^ source.liquidsoap
#       ^^ source.liquidsoap keyword.operator.set.liquidsoap
#         ^ source.liquidsoap
#          ^^^^ source.liquidsoap variable.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                            ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                ^ source.liquidsoap meta.function-call.liquidsoap
>    log.debug(label=id, "Updated #{nu()} files.")
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap variable.liquidsoap
#       ^ source.liquidsoap meta.function-call.liquidsoap
#        ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
#              ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                         ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                 ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                   ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                     ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                      ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                       ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                        ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                               ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                ^ source.liquidsoap meta.function-call.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  # Make sure that new files from directories are registered.
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  def scan(~progress=fun(_,_)->())
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#          ^ source.liquidsoap
#           ^ source.liquidsoap
#            ^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                    ^ source.liquidsoap
#                     ^^^ source.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                        ^ source.liquidsoap
#                         ^ source.liquidsoap variable.liquidsoap
#                          ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                           ^ source.liquidsoap variable.liquidsoap
#                            ^ source.liquidsoap
#                             ^^ source.liquidsoap keyword.control.function.declaration.liquidsoap
#                               ^ source.liquidsoap
#                                ^ source.liquidsoap
#                                 ^ source.liquidsoap
>    l = list.map(fun(d) -> file.ls(absolute=true, recursive=true, d), directories())
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^^ source.liquidsoap variable.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap
#             ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap
#                 ^^^ source.liquidsoap meta.function-call.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^^ source.liquidsoap meta.function-call.liquidsoap keyword.control.function.declaration.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
#                           ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                   ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                            ^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap constant.language.boolean.liquidsoap
#                                                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                 ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                  ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                                           ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                            ^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap constant.language.boolean.liquidsoap
#                                                                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                 ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                  ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                   ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                    ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                     ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                      ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                 ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                  ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                   ^ source.liquidsoap meta.function-call.liquidsoap
>    l = list.flatten(l)
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^^ source.liquidsoap variable.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap
#             ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap
>    n = ref(0)
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap constant.numeric.decimal.integer.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
>    len = list.length(l)
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#       ^^ source.liquidsoap
#         ^ source.liquidsoap
#          ^^^^ source.liquidsoap variable.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
>    def add(f)
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#       ^ source.liquidsoap
#        ^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#           ^ source.liquidsoap
#            ^ source.liquidsoap variable.liquidsoap
#             ^ source.liquidsoap
>      ref.incr(n)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap variable.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap
>      progress(n(),len)
#^^^^^^ source.liquidsoap
#      ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                   ^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap
>      add(f)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
>    end
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>    list.iter(add, l)
#^^^^ source.liquidsoap
#    ^^^^ source.liquidsoap variable.liquidsoap
#        ^ source.liquidsoap meta.function-call.liquidsoap
#         ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
#              ^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  # Increment when the format of the db changes
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  db_version = 1
#^^ source.liquidsoap
#  ^^^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#            ^^ source.liquidsoap
#              ^ source.liquidsoap
#               ^ source.liquidsoap constant.numeric.decimal.integer.liquidsoap
>
>  # Load from the persistent file.
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  def load()
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#          ^ source.liquidsoap
#           ^ source.liquidsoap
>    db := []
#^^^^ source.liquidsoap
#    ^^ source.liquidsoap variable.liquidsoap
#      ^ source.liquidsoap
#       ^^ source.liquidsoap keyword.operator.set.liquidsoap
#         ^^^^ source.liquidsoap
>    if null.defined(persistency) then
#^^^^ source.liquidsoap
#    ^^ source.liquidsoap keyword.control.liquidsoap
#      ^ source.liquidsoap
#       ^^^^ source.liquidsoap variable.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
#            ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                ^ source.liquidsoap
#                                 ^^^^ source.liquidsoap keyword.control.liquidsoap
>      f = null.get(persistency)
#^^^^^^ source.liquidsoap
#      ^ source.liquidsoap entity.name.function.binding.liquidsoap
#       ^^ source.liquidsoap
#         ^ source.liquidsoap
#          ^^^^ source.liquidsoap variable.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap
>      if file.exists(f) then
#^^^^^^ source.liquidsoap
#      ^^ source.liquidsoap keyword.control.liquidsoap
#        ^ source.liquidsoap
#         ^^^^ source.liquidsoap variable.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
#              ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap
#                       ^ source.liquidsoap
#                        ^^^^ source.liquidsoap keyword.control.liquidsoap
>        try
#^^^^^^^^ source.liquidsoap
#        ^^^ source.liquidsoap keyword.control.liquidsoap
>          let json.parse ((v , parsed) : (int * [(string * [(string * string)])]?)) = file.contents(f)
#^^^^^^^^^^ source.liquidsoap
#          ^^^ source.liquidsoap keyword.other.function.declaration.liquidsoap
#             ^ source.liquidsoap
#              ^^^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#                        ^ source.liquidsoap
#                         ^^ source.liquidsoap
#                           ^ source.liquidsoap variable.liquidsoap
#                            ^ source.liquidsoap
#                             ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                              ^ source.liquidsoap
#                               ^^^^^^ source.liquidsoap variable.liquidsoap
#                                     ^^ source.liquidsoap
#                                       ^ source.liquidsoap meta.type-annotation.liquidsoap keyword.other.cast.liquidsoap
#                                        ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                         ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                          ^^^ source.liquidsoap meta.type-annotation.liquidsoap storage.type.ground.liquidsoap
#                                             ^^^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                 ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                  ^^^^^^^^^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                           ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                            ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                             ^^^^^^^^^^^^^^^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                                            ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                                             ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                                              ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                                               ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                                                ^ source.liquidsoap meta.type-annotation.liquidsoap keyword.other.liquidsoap
#                                                                                 ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                                                  ^ source.liquidsoap meta.type-annotation.liquidsoap
#                                                                                   ^^^ source.liquidsoap
#                                                                                      ^^^^ source.liquidsoap variable.liquidsoap
#                                                                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                           ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                    ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                                                     ^ source.liquidsoap meta.function-call.liquidsoap
>          if v == db_version and null.defined(parsed) then
#^^^^^^^^^^ source.liquidsoap
#          ^^ source.liquidsoap keyword.control.liquidsoap
#            ^ source.liquidsoap
#             ^ source.liquidsoap variable.liquidsoap
#              ^ source.liquidsoap
#               ^^ source.liquidsoap keyword.operator.compare.liquidsoap
#                 ^ source.liquidsoap
#                  ^^^^^^^^^^ source.liquidsoap variable.liquidsoap
#                            ^ source.liquidsoap
#                             ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
#                                ^ source.liquidsoap
#                                 ^^^^ source.liquidsoap variable.liquidsoap
#                                     ^ source.liquidsoap meta.function-call.liquidsoap
#                                      ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                              ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap
#                                                     ^ source.liquidsoap
#                                                      ^^^^ source.liquidsoap keyword.control.liquidsoap
>            db := null.get(parsed)
#^^^^^^^^^^^^ source.liquidsoap
#            ^^ source.liquidsoap variable.liquidsoap
#              ^ source.liquidsoap
#               ^^ source.liquidsoap keyword.operator.set.liquidsoap
#                 ^ source.liquidsoap
#                  ^^^^ source.liquidsoap variable.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap
#                       ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
#                           ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap
>          end
#^^^^^^^^^^ source.liquidsoap
#          ^^^ source.liquidsoap keyword.control.liquidsoap
>        catch e do
#^^^^^^^^ source.liquidsoap
#        ^^^^^ source.liquidsoap keyword.control.liquidsoap
#             ^ source.liquidsoap
#              ^ source.liquidsoap entity.name.function.binding.liquidsoap
#               ^ source.liquidsoap
#                ^^ source.liquidsoap keyword.control.liquidsoap
>          log.important(label=id,"Failed to parse persistent file #{f}: #{e.kind}: #{e.message}")
#^^^^^^^^^^ source.liquidsoap
#          ^^^ source.liquidsoap variable.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
#              ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                             ^ source.liquidsoap meta.function-call.liquidsoap
#                              ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                 ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                  ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                    ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                     ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                      ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                        ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap keyword.other.liquidsoap
#                                                                            ^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.method.liquidsoap
#                                                                                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                                 ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                   ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                                     ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                                      ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap keyword.other.liquidsoap
#                                                                                       ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.method.liquidsoap
#                                                                                              ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                                               ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                                ^ source.liquidsoap meta.function-call.liquidsoap
>        end
#^^^^^^^^ source.liquidsoap
#        ^^^ source.liquidsoap keyword.control.liquidsoap
>      end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.control.liquidsoap
>    end
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap keyword.control.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  # Store the file in a persistent file.
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  def store()
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#           ^ source.liquidsoap
#            ^ source.liquidsoap
>    if null.defined(persistency) then
#^^^^ source.liquidsoap
#    ^^ source.liquidsoap keyword.control.liquidsoap
#      ^ source.liquidsoap
#       ^^^^ source.liquidsoap variable.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
#            ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                ^ source.liquidsoap
#                                 ^^^^ source.liquidsoap keyword.control.liquidsoap
>      f = null.get(persistency)
#^^^^^^ source.liquidsoap
#      ^ source.liquidsoap entity.name.function.binding.liquidsoap
#       ^^ source.liquidsoap
#         ^ source.liquidsoap
#          ^^^^ source.liquidsoap variable.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap
>      data = json.stringify(compact=true, (db_version, db()))
#^^^^^^ source.liquidsoap
#      ^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#          ^^ source.liquidsoap
#            ^ source.liquidsoap
#             ^^^^ source.liquidsoap variable.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap
#                  ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap
#                            ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^^^^ source.liquidsoap meta.function-call.liquidsoap constant.language.boolean.liquidsoap
#                                        ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                         ^^ source.liquidsoap meta.function-call.liquidsoap
#                                           ^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                     ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                      ^ source.liquidsoap meta.function-call.liquidsoap
#                                                       ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                         ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                          ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                                            ^^ source.liquidsoap
>      file.write(data=data, f)
#^^^^^^ source.liquidsoap
#      ^^^^ source.liquidsoap variable.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap
#           ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap
#                 ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                           ^ source.liquidsoap meta.function-call.liquidsoap
#                            ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                             ^ source.liquidsoap meta.function-call.liquidsoap
>      log.info(label=id,"Wrote persistent file #{f}")
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap variable.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap
#                     ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                        ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                         ^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                               ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                 ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                  ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap
>    end
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap keyword.control.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  # Refresh the library.
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  def refresh()
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#             ^ source.liquidsoap
#              ^ source.liquidsoap
>    log.info(label=id, "Refreshing the library...")
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap variable.liquidsoap
#       ^ source.liquidsoap meta.function-call.liquidsoap
#        ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap
#             ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                      ^ source.liquidsoap meta.function-call.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                        ^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                 ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                  ^ source.liquidsoap meta.function-call.liquidsoap
>    t = time()
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
>    update()
#^^^^ source.liquidsoap
#    ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
>    scan()
#^^^^ source.liquidsoap
#    ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#        ^ source.liquidsoap meta.function-call.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
>    store()
#^^^^ source.liquidsoap
#    ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap
>    log.info(label=id, "Refreshed the library in #{dt(t)}s.")
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap variable.liquidsoap
#       ^ source.liquidsoap meta.function-call.liquidsoap
#        ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap
#             ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                      ^ source.liquidsoap meta.function-call.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                        ^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                 ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                   ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                     ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                      ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                       ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                        ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                         ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                            ^ source.liquidsoap meta.function-call.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  # Find all files matching given criteria.
#^^ source.liquidsoap
#  ^ source.liquidsoap comment.line.number-sign.liquidsoap
#   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap comment.line.number-sign.liquidsoap
>  def find(~case_sensitive=true, ~artist=null(), ~artist_contains=null(), ~artist_matches=null(), ~album=null(), ~genre=null(), ~title=null(), ~title_contains=null(), ~filename=null(), ~filename_contains=null(), ~filename_matches=null(), ~year=null(), ~year_ge=null(), ~year_lt=null(), ~bpm=null(), ~bpm_ge=null(), bpm_lt=null(), ~predicate=(fun(_)->true))
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#          ^ source.liquidsoap
#           ^ source.liquidsoap
#            ^^^^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                          ^ source.liquidsoap
#                           ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                               ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                ^ source.liquidsoap
#                                 ^ source.liquidsoap
#                                  ^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                        ^ source.liquidsoap
#                                         ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                              ^ source.liquidsoap meta.function-call.liquidsoap
#                                               ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                ^ source.liquidsoap
#                                                 ^ source.liquidsoap
#                                                  ^^^^^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                 ^ source.liquidsoap
#                                                                  ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                      ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                       ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                        ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                         ^ source.liquidsoap
#                                                                          ^ source.liquidsoap
#                                                                           ^^^^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                         ^ source.liquidsoap
#                                                                                          ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                              ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                 ^ source.liquidsoap
#                                                                                                  ^ source.liquidsoap
#                                                                                                   ^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                        ^ source.liquidsoap
#                                                                                                         ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                              ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                               ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                ^ source.liquidsoap
#                                                                                                                 ^ source.liquidsoap
#                                                                                                                  ^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                       ^ source.liquidsoap
#                                                                                                                        ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                              ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                               ^ source.liquidsoap
#                                                                                                                                ^ source.liquidsoap
#                                                                                                                                 ^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                      ^ source.liquidsoap
#                                                                                                                                       ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                             ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                              ^ source.liquidsoap
#                                                                                                                                               ^ source.liquidsoap
#                                                                                                                                                ^^^^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                              ^ source.liquidsoap
#                                                                                                                                                               ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                    ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                     ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                      ^ source.liquidsoap
#                                                                                                                                                                       ^ source.liquidsoap
#                                                                                                                                                                        ^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                                                ^ source.liquidsoap
#                                                                                                                                                                                 ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                                     ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                      ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                       ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                                        ^ source.liquidsoap
#                                                                                                                                                                                         ^ source.liquidsoap
#                                                                                                                                                                                          ^^^^^^^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                                                                           ^ source.liquidsoap
#                                                                                                                                                                                                            ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                                                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                  ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                                                                   ^ source.liquidsoap
#                                                                                                                                                                                                                    ^ source.liquidsoap
#                                                                                                                                                                                                                     ^^^^^^^^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                                                                                                     ^ source.liquidsoap
#                                                                                                                                                                                                                                      ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                                                                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                            ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                                                                                             ^ source.liquidsoap
#                                                                                                                                                                                                                                              ^ source.liquidsoap
#                                                                                                                                                                                                                                               ^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                                                                                                                   ^ source.liquidsoap
#                                                                                                                                                                                                                                                    ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                                                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                         ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                          ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                                                                                                           ^ source.liquidsoap
#                                                                                                                                                                                                                                                            ^ source.liquidsoap
#                                                                                                                                                                                                                                                             ^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                                                                                                                                    ^ source.liquidsoap
#                                                                                                                                                                                                                                                                     ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                                                                                                                         ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                           ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                                                                                                                            ^ source.liquidsoap
#                                                                                                                                                                                                                                                                             ^ source.liquidsoap
#                                                                                                                                                                                                                                                                              ^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                                                                                                                                                     ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                      ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                                                                                                                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                                            ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                                                                                                                                             ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                              ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                               ^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                                                                                                                                                                  ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                   ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                                                                                                                                                       ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                                                         ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                                                                                                                                                          ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                           ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                            ^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                                                                                                                                                                                  ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                                   ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                                                                                                                                                                       ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                                                                         ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                                                                                                                                                                          ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                                           ^^^^^^ source.liquidsoap variable.liquidsoap
#                                                                                                                                                                                                                                                                                                                                 ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                                                  ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                                                                                                                                                                                                                      ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                                                                                       ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                                                                                                                                                                                                        ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                                                                                                                                                                                                                         ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                                                          ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                                                           ^^^^^^^^^ source.liquidsoap variable.parameter.liquidsoap
#                                                                                                                                                                                                                                                                                                                                                    ^^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                                                                      ^^^ source.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                                                                                                                                                                                                                                                                                                                                                         ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                                                                          ^ source.liquidsoap variable.liquidsoap
#                                                                                                                                                                                                                                                                                                                                                           ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                                                                            ^^ source.liquidsoap keyword.control.function.declaration.liquidsoap
#                                                                                                                                                                                                                                                                                                                                                              ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                                                                                                                                                                                                                                                                                                                                  ^ source.liquidsoap
#                                                                                                                                                                                                                                                                                                                                                                   ^ source.liquidsoap
>    def p(m)
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#       ^ source.liquidsoap
#        ^ source.liquidsoap entity.name.function.binding.liquidsoap
#         ^ source.liquidsoap
#          ^ source.liquidsoap variable.liquidsoap
#           ^ source.liquidsoap
>      def eq(s,t) = if case_sensitive then s == t else string.case(s) == string.case(t) end end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#         ^ source.liquidsoap
#          ^^ source.liquidsoap entity.name.function.binding.liquidsoap
#            ^ source.liquidsoap
#             ^ source.liquidsoap variable.liquidsoap
#              ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#               ^ source.liquidsoap variable.liquidsoap
#                ^ source.liquidsoap
#                 ^^ source.liquidsoap
#                   ^ source.liquidsoap
#                    ^^ source.liquidsoap keyword.control.liquidsoap
#                      ^ source.liquidsoap
#                       ^^^^^^^^^^^^^^ source.liquidsoap variable.liquidsoap
#                                     ^ source.liquidsoap
#                                      ^^^^ source.liquidsoap keyword.control.liquidsoap
#                                          ^ source.liquidsoap
#                                           ^ source.liquidsoap variable.liquidsoap
#                                            ^ source.liquidsoap
#                                             ^^ source.liquidsoap keyword.operator.compare.liquidsoap
#                                               ^ source.liquidsoap
#                                                ^ source.liquidsoap variable.liquidsoap
#                                                 ^ source.liquidsoap
#                                                  ^^^^ source.liquidsoap keyword.control.liquidsoap
#                                                      ^ source.liquidsoap
#                                                       ^^^^^^ source.liquidsoap variable.liquidsoap
#                                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                                              ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                  ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                   ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                    ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                     ^ source.liquidsoap
#                                                                      ^^ source.liquidsoap keyword.operator.compare.liquidsoap
#                                                                        ^ source.liquidsoap
#                                                                         ^^^^^^ source.liquidsoap variable.liquidsoap
#                                                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                    ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                     ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                                      ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                       ^ source.liquidsoap
#                                                                                        ^^^ source.liquidsoap keyword.control.liquidsoap
#                                                                                           ^ source.liquidsoap
#                                                                                            ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>      def contains(s, t) = if case_sensitive then string.contains(substring=s, t) else string.contains(substring=string.case(s), string.case(t)) end end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#         ^ source.liquidsoap
#          ^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#                  ^ source.liquidsoap
#                   ^ source.liquidsoap variable.liquidsoap
#                    ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                     ^ source.liquidsoap
#                      ^ source.liquidsoap variable.liquidsoap
#                       ^ source.liquidsoap
#                        ^^ source.liquidsoap
#                          ^ source.liquidsoap
#                           ^^ source.liquidsoap keyword.control.liquidsoap
#                             ^ source.liquidsoap
#                              ^^^^^^^^^^^^^^ source.liquidsoap variable.liquidsoap
#                                            ^ source.liquidsoap
#                                             ^^^^ source.liquidsoap keyword.control.liquidsoap
#                                                 ^ source.liquidsoap
#                                                  ^^^^^^ source.liquidsoap variable.liquidsoap
#                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                         ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                  ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                            ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                             ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                              ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                               ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                 ^ source.liquidsoap
#                                                                                  ^^^^ source.liquidsoap keyword.control.liquidsoap
#                                                                                      ^ source.liquidsoap
#                                                                                       ^^^^^^ source.liquidsoap variable.liquidsoap
#                                                                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                              ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                      ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                       ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                                                                                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                 ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                                                                       ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                                                        ^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                            ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                                                             ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                                                                              ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                                                               ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                 ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                                                                                       ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                        ^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                                                                            ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                             ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                                                                                              ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                                                                ^ source.liquidsoap
#                                                                                                                                                 ^^^ source.liquidsoap keyword.control.liquidsoap
#                                                                                                                                                    ^ source.liquidsoap
#                                                                                                                                                     ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>      def eqf(k,v) = null.defined(v) ? eq(m[k], null.get(v)) : true end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#         ^ source.liquidsoap
#          ^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#             ^ source.liquidsoap
#              ^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                ^ source.liquidsoap variable.liquidsoap
#                 ^ source.liquidsoap
#                  ^^ source.liquidsoap
#                    ^ source.liquidsoap
#                     ^^^^ source.liquidsoap variable.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap
#                          ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^ source.liquidsoap
#                                     ^ source.liquidsoap keyword.control.liquidsoap
#                                      ^ source.liquidsoap
#                                       ^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                         ^ source.liquidsoap meta.function-call.liquidsoap
#                                          ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                            ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                              ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                     ^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                        ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                         ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                          ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                                            ^ source.liquidsoap
#                                                             ^ source.liquidsoap keyword.control.liquidsoap
#                                                              ^ source.liquidsoap
#                                                               ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                                   ^ source.liquidsoap
#                                                                    ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>      def ctf(k,v) = null.defined(v) ? contains(null.get(v), m[k]) : true end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#         ^ source.liquidsoap
#          ^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#             ^ source.liquidsoap
#              ^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                ^ source.liquidsoap variable.liquidsoap
#                 ^ source.liquidsoap
#                  ^^ source.liquidsoap
#                    ^ source.liquidsoap
#                     ^^^^ source.liquidsoap variable.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap
#                          ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^ source.liquidsoap
#                                     ^ source.liquidsoap keyword.control.liquidsoap
#                                      ^ source.liquidsoap
#                                       ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                     ^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                        ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                         ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                          ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                           ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                                             ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                              ^ source.liquidsoap meta.function-call.liquidsoap
#                                                               ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                  ^ source.liquidsoap
#                                                                   ^ source.liquidsoap keyword.control.liquidsoap
#                                                                    ^ source.liquidsoap
#                                                                     ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                                         ^ source.liquidsoap
#                                                                          ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>      def mtf(k,v) = null.defined(v) ? string.match(pattern=null.get(v), m[k]) : true end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#         ^ source.liquidsoap
#          ^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#             ^ source.liquidsoap
#              ^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                ^ source.liquidsoap variable.liquidsoap
#                 ^ source.liquidsoap
#                  ^^ source.liquidsoap
#                    ^ source.liquidsoap
#                     ^^^^ source.liquidsoap variable.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap
#                          ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^ source.liquidsoap
#                                     ^ source.liquidsoap keyword.control.liquidsoap
#                                      ^ source.liquidsoap
#                                       ^^^^^^ source.liquidsoap variable.liquidsoap
#                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                              ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                                    ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                                            ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                 ^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                    ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                     ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                      ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                       ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                         ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                           ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                              ^ source.liquidsoap
#                                                                               ^ source.liquidsoap keyword.control.liquidsoap
#                                                                                ^ source.liquidsoap
#                                                                                 ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                                                     ^ source.liquidsoap
#                                                                                      ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>      eqf("artist", artist)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      ctf("artist", artist_contains)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      mtf("artist", artist_matches)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                  ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      eqf("album", album)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      eqf("genre", genre)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      eqf("title", title)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      ctf("title", title_contains)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                  ^ source.liquidsoap meta.function-call.liquidsoap
#                   ^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      eqf("filename", filename)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      ctf("basename", filename_contains)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                       ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      mtf("basename", filename_matches)
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#           ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                      ^ source.liquidsoap meta.function-call.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      if null.defined(year) or null.defined(year_ge) or null.defined(year_lt) then
#^^^^^^ source.liquidsoap
#      ^^ source.liquidsoap keyword.control.liquidsoap
#        ^ source.liquidsoap
#         ^^^^ source.liquidsoap variable.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
#              ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
#                           ^ source.liquidsoap
#                            ^^ source.liquidsoap keyword.operator.boolean.liquidsoap
#                              ^ source.liquidsoap
#                               ^^^^ source.liquidsoap variable.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                            ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                                    ^ source.liquidsoap
#                                                     ^^ source.liquidsoap keyword.operator.boolean.liquidsoap
#                                                       ^ source.liquidsoap
#                                                        ^^^^ source.liquidsoap variable.liquidsoap
#                                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                                             ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                    ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                     ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                             ^ source.liquidsoap
#                                                                              ^^^^ source.liquidsoap keyword.control.liquidsoap
>        if string.is_int(m["year"]) then
#^^^^^^^^ source.liquidsoap
#        ^^ source.liquidsoap keyword.control.liquidsoap
#          ^ source.liquidsoap
#           ^^^^^^ source.liquidsoap variable.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap
#                  ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                            ^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap
#                                   ^ source.liquidsoap
#                                    ^^^^ source.liquidsoap keyword.control.liquidsoap
>          y = string.to_int(m["year"])
#^^^^^^^^^^ source.liquidsoap
#          ^ source.liquidsoap entity.name.function.binding.liquidsoap
#           ^^ source.liquidsoap
#             ^ source.liquidsoap
#              ^^^^^^ source.liquidsoap variable.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap
#                     ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap
#                            ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                             ^ source.liquidsoap meta.function-call.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                               ^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                    ^ source.liquidsoap meta.function-call.liquidsoap
#                                     ^ source.liquidsoap meta.function-call.liquidsoap
>          (null.defined(year) ? y == null.get(year) : true)
#^^^^^^^^^^^ source.liquidsoap
#           ^^^^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                            ^ source.liquidsoap meta.function-call.liquidsoap
#                             ^ source.liquidsoap
#                              ^ source.liquidsoap keyword.control.liquidsoap
#                               ^ source.liquidsoap
#                                ^ source.liquidsoap variable.liquidsoap
#                                 ^ source.liquidsoap
#                                  ^^ source.liquidsoap keyword.operator.compare.liquidsoap
#                                    ^ source.liquidsoap
#                                     ^^^^ source.liquidsoap variable.liquidsoap
#                                         ^ source.liquidsoap meta.function-call.liquidsoap
#                                          ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                             ^ source.liquidsoap meta.function-call.liquidsoap
#                                              ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                  ^ source.liquidsoap meta.function-call.liquidsoap
#                                                   ^ source.liquidsoap
#                                                    ^ source.liquidsoap keyword.control.liquidsoap
#                                                     ^ source.liquidsoap
#                                                      ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                          ^^ source.liquidsoap
>          and
#^^^^^^^^^^ source.liquidsoap
#          ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>          (null.defined(year_ge) ? y >= null.get(year_ge) : true)
#^^^^^^^^^^^ source.liquidsoap
#           ^^^^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                ^ source.liquidsoap
#                                 ^ source.liquidsoap keyword.control.liquidsoap
#                                  ^ source.liquidsoap
#                                   ^ source.liquidsoap variable.liquidsoap
#                                    ^ source.liquidsoap
#                                     ^^ source.liquidsoap keyword.operator.compare.liquidsoap
#                                       ^ source.liquidsoap
#                                        ^^^^ source.liquidsoap variable.liquidsoap
#                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                             ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                                 ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                         ^ source.liquidsoap
#                                                          ^ source.liquidsoap keyword.control.liquidsoap
#                                                           ^ source.liquidsoap
#                                                            ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                                ^^ source.liquidsoap
>          and
#^^^^^^^^^^ source.liquidsoap
#          ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>          (null.defined(year_lt) ? y < null.get(year_lt) : true)
#^^^^^^^^^^^ source.liquidsoap
#           ^^^^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                ^ source.liquidsoap
#                                 ^ source.liquidsoap keyword.control.liquidsoap
#                                  ^ source.liquidsoap
#                                   ^ source.liquidsoap variable.liquidsoap
#                                    ^ source.liquidsoap
#                                     ^ source.liquidsoap keyword.operator.compare.liquidsoap
#                                      ^ source.liquidsoap
#                                       ^^^^ source.liquidsoap variable.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                            ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                       ^ source.liquidsoap meta.function-call.liquidsoap
#                                                        ^ source.liquidsoap
#                                                         ^ source.liquidsoap keyword.control.liquidsoap
#                                                          ^ source.liquidsoap
#                                                           ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                               ^^ source.liquidsoap
>        else
#^^^^^^^^ source.liquidsoap
#        ^^^^ source.liquidsoap keyword.control.liquidsoap
>          false
#^^^^^^^^^^ source.liquidsoap
#          ^^^^^ source.liquidsoap constant.language.boolean.liquidsoap
>        end
#^^^^^^^^ source.liquidsoap
#        ^^^ source.liquidsoap keyword.control.liquidsoap
>      else
#^^^^^^ source.liquidsoap
#      ^^^^ source.liquidsoap keyword.control.liquidsoap
>        true
#^^^^^^^^ source.liquidsoap
#        ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
>      end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.control.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      if null.defined(bpm) or null.defined(bpm_ge) or null.defined(bpm_lt) then
#^^^^^^ source.liquidsoap
#      ^^ source.liquidsoap keyword.control.liquidsoap
#        ^ source.liquidsoap
#         ^^^^ source.liquidsoap variable.liquidsoap
#             ^ source.liquidsoap meta.function-call.liquidsoap
#              ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap
#                          ^ source.liquidsoap
#                           ^^ source.liquidsoap keyword.operator.boolean.liquidsoap
#                             ^ source.liquidsoap
#                              ^^^^ source.liquidsoap variable.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap
#                                   ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                           ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                                  ^ source.liquidsoap
#                                                   ^^ source.liquidsoap keyword.operator.boolean.liquidsoap
#                                                     ^ source.liquidsoap
#                                                      ^^^^ source.liquidsoap variable.liquidsoap
#                                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                                           ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                  ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                   ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                         ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                          ^ source.liquidsoap
#                                                                           ^^^^ source.liquidsoap keyword.control.liquidsoap
>        if string.is_int(m["bpm"]) then
#^^^^^^^^ source.liquidsoap
#        ^^ source.liquidsoap keyword.control.liquidsoap
#          ^ source.liquidsoap
#           ^^^^^^ source.liquidsoap variable.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap
#                  ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                            ^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap
#                                  ^ source.liquidsoap
#                                   ^^^^ source.liquidsoap keyword.control.liquidsoap
>          b = string.to_int(m["bpm"])
#^^^^^^^^^^ source.liquidsoap
#          ^ source.liquidsoap entity.name.function.binding.liquidsoap
#           ^^ source.liquidsoap
#             ^ source.liquidsoap
#              ^^^^^^ source.liquidsoap variable.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap
#                     ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap
#                            ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                             ^ source.liquidsoap meta.function-call.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                               ^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                  ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^ source.liquidsoap meta.function-call.liquidsoap
>          (null.defined(bpm) ? b == null.get(bpm) : true)
#^^^^^^^^^^^ source.liquidsoap
#           ^^^^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap
#                            ^ source.liquidsoap
#                             ^ source.liquidsoap keyword.control.liquidsoap
#                              ^ source.liquidsoap
#                               ^ source.liquidsoap variable.liquidsoap
#                                ^ source.liquidsoap
#                                 ^^ source.liquidsoap keyword.operator.compare.liquidsoap
#                                   ^ source.liquidsoap
#                                    ^^^^ source.liquidsoap variable.liquidsoap
#                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                         ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                             ^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                ^ source.liquidsoap meta.function-call.liquidsoap
#                                                 ^ source.liquidsoap
#                                                  ^ source.liquidsoap keyword.control.liquidsoap
#                                                   ^ source.liquidsoap
#                                                    ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                        ^^ source.liquidsoap
>          and
#^^^^^^^^^^ source.liquidsoap
#          ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>          (null.defined(bpm_ge) ? b >= null.get(bpm_ge) : true)
#^^^^^^^^^^^ source.liquidsoap
#           ^^^^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap
#                               ^ source.liquidsoap
#                                ^ source.liquidsoap keyword.control.liquidsoap
#                                 ^ source.liquidsoap
#                                  ^ source.liquidsoap variable.liquidsoap
#                                   ^ source.liquidsoap
#                                    ^^ source.liquidsoap keyword.operator.compare.liquidsoap
#                                      ^ source.liquidsoap
#                                       ^^^^ source.liquidsoap variable.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                            ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                      ^ source.liquidsoap meta.function-call.liquidsoap
#                                                       ^ source.liquidsoap
#                                                        ^ source.liquidsoap keyword.control.liquidsoap
#                                                         ^ source.liquidsoap
#                                                          ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                              ^^ source.liquidsoap
>          and
#^^^^^^^^^^ source.liquidsoap
#          ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>          (null.defined(bpm_lt) ? b < null.get(bpm_lt) : true)
#^^^^^^^^^^^ source.liquidsoap
#           ^^^^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
#                        ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap
#                               ^ source.liquidsoap
#                                ^ source.liquidsoap keyword.control.liquidsoap
#                                 ^ source.liquidsoap
#                                  ^ source.liquidsoap variable.liquidsoap
#                                   ^ source.liquidsoap
#                                    ^ source.liquidsoap keyword.operator.compare.liquidsoap
#                                     ^ source.liquidsoap
#                                      ^^^^ source.liquidsoap variable.liquidsoap
#                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                           ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                              ^ source.liquidsoap meta.function-call.liquidsoap
#                                               ^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                     ^ source.liquidsoap meta.function-call.liquidsoap
#                                                      ^ source.liquidsoap
#                                                       ^ source.liquidsoap keyword.control.liquidsoap
#                                                        ^ source.liquidsoap
#                                                         ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
#                                                             ^^ source.liquidsoap
>        else
#^^^^^^^^ source.liquidsoap
#        ^^^^ source.liquidsoap keyword.control.liquidsoap
>          false
#^^^^^^^^^^ source.liquidsoap
#          ^^^^^ source.liquidsoap constant.language.boolean.liquidsoap
>        end
#^^^^^^^^ source.liquidsoap
#        ^^^ source.liquidsoap keyword.control.liquidsoap
>      else
#^^^^^^ source.liquidsoap
#      ^^^^ source.liquidsoap keyword.control.liquidsoap
>        true
#^^^^^^^^ source.liquidsoap
#        ^^^^ source.liquidsoap constant.language.boolean.liquidsoap
>      end
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.control.liquidsoap
>      and
#^^^^^^ source.liquidsoap
#      ^^^ source.liquidsoap keyword.operator.boolean.liquidsoap
>      predicate(m)
#^^^^^^ source.liquidsoap
#      ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap
>    end
#^^^^ source.liquidsoap
#    ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>    l = list.filter(fun (fm) -> p(snd(fm)), db())
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^^ source.liquidsoap variable.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap
#             ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                   ^ source.liquidsoap meta.function-call.liquidsoap
#                    ^^^ source.liquidsoap meta.function-call.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                       ^^ source.liquidsoap meta.function-call.liquidsoap
#                         ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                           ^ source.liquidsoap meta.function-call.liquidsoap
#                            ^ source.liquidsoap meta.function-call.liquidsoap
#                             ^^ source.liquidsoap meta.function-call.liquidsoap keyword.control.function.declaration.liquidsoap
#                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                 ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                  ^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                     ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                      ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                        ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                         ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                          ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                           ^ source.liquidsoap meta.function-call.liquidsoap
#                                            ^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                              ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                               ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                ^ source.liquidsoap meta.function-call.liquidsoap
>    l = list.map(fst, l)
#^^^^ source.liquidsoap
#    ^ source.liquidsoap entity.name.function.binding.liquidsoap
#     ^^ source.liquidsoap
#       ^ source.liquidsoap
#        ^^^^ source.liquidsoap variable.liquidsoap
#            ^ source.liquidsoap meta.function-call.liquidsoap
#             ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                ^ source.liquidsoap meta.function-call.liquidsoap
#                 ^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                       ^ source.liquidsoap meta.function-call.liquidsoap
>    l
#^^^^ source.liquidsoap
#    ^ source.liquidsoap variable.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  t = time()
#^^ source.liquidsoap
#  ^ source.liquidsoap entity.name.function.binding.liquidsoap
#   ^^ source.liquidsoap
#     ^ source.liquidsoap
#      ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
>  load()
#^^ source.liquidsoap
#  ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#      ^ source.liquidsoap meta.function-call.liquidsoap
#       ^ source.liquidsoap meta.function-call.liquidsoap
>  log.important(label=id,"Loaded library from #{persistency} in #{dt(t)}s: #{list.length(db())} entries")
#^^ source.liquidsoap
#  ^^^ source.liquidsoap variable.liquidsoap
#     ^ source.liquidsoap meta.function-call.liquidsoap
#      ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                         ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                          ^^^^^^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                              ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                            ^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                  ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                    ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                     ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                      ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                       ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                        ^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                           ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                             ^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                                 ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                                  ^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                        ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                                         ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                            ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                                             ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                                              ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                                               ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                                       ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
>  t = time()
#^^ source.liquidsoap
#  ^ source.liquidsoap entity.name.function.binding.liquidsoap
#   ^^ source.liquidsoap
#     ^ source.liquidsoap
#      ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
>  progress = if initial_progress then fun(n,l) -> print(newline=false,"#{id}: updating #{n*100/l}%...\r") else fun(_,_) -> () end
#^^ source.liquidsoap
#  ^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#          ^^ source.liquidsoap
#            ^ source.liquidsoap
#             ^^ source.liquidsoap keyword.control.liquidsoap
#               ^ source.liquidsoap
#                ^^^^^^^^^^^^^^^^ source.liquidsoap variable.liquidsoap
#                                ^ source.liquidsoap
#                                 ^^^^ source.liquidsoap keyword.control.liquidsoap
#                                     ^ source.liquidsoap
#                                      ^^^ source.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                                         ^ source.liquidsoap
#                                          ^ source.liquidsoap variable.liquidsoap
#                                           ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                            ^ source.liquidsoap variable.liquidsoap
#                                             ^ source.liquidsoap
#                                              ^ source.liquidsoap
#                                               ^^ source.liquidsoap keyword.control.function.declaration.liquidsoap
#                                                 ^ source.liquidsoap
#                                                  ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                       ^ source.liquidsoap meta.function-call.liquidsoap
#                                                        ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                ^^^^^ source.liquidsoap meta.function-call.liquidsoap constant.language.boolean.liquidsoap
#                                                                     ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                      ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                       ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                         ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                            ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                       ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                                         ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                                          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap keyword.operator.arithmetic.liquidsoap
#                                                                                           ^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap constant.numeric.decimal.integer.liquidsoap
#                                                                                              ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap keyword.operator.arithmetic.liquidsoap
#                                                                                               ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                                                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                                                 ^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                                     ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap constant.character.escape.liquidsoap
#                                                                                                       ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                         ^ source.liquidsoap
#                                                                                                          ^^^^ source.liquidsoap keyword.control.liquidsoap
#                                                                                                              ^ source.liquidsoap
#                                                                                                               ^^^ source.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                                                                                                                  ^ source.liquidsoap
#                                                                                                                   ^ source.liquidsoap variable.liquidsoap
#                                                                                                                    ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                     ^ source.liquidsoap variable.liquidsoap
#                                                                                                                      ^ source.liquidsoap
#                                                                                                                       ^ source.liquidsoap
#                                                                                                                        ^^ source.liquidsoap keyword.control.function.declaration.liquidsoap
#                                                                                                                          ^^^^ source.liquidsoap
#                                                                                                                              ^^^ source.liquidsoap keyword.control.liquidsoap
>  update(progress=progress)
#^^ source.liquidsoap
#  ^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#        ^ source.liquidsoap meta.function-call.liquidsoap
#         ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap
#                  ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                          ^ source.liquidsoap meta.function-call.liquidsoap
>  log.important(label=id,"Updated library in #{dt(t)}s: #{list.length(db())} entries")
#^^ source.liquidsoap
#  ^^^ source.liquidsoap variable.liquidsoap
#     ^ source.liquidsoap meta.function-call.liquidsoap
#      ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                         ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                          ^^^^^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                             ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                               ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                 ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                  ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                     ^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                        ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                          ^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                              ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                               ^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                     ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                      ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                        ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                         ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                            ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                    ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                     ^ source.liquidsoap meta.function-call.liquidsoap
>  t = time()
#^^ source.liquidsoap
#  ^ source.liquidsoap entity.name.function.binding.liquidsoap
#   ^^ source.liquidsoap
#     ^ source.liquidsoap
#      ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap
#           ^ source.liquidsoap meta.function-call.liquidsoap
>  progress = if initial_progress then fun(n,l) -> print(newline=false,"#{id}: scanning #{n*100/l}%...\r") else fun(_,_) -> () end
#^^ source.liquidsoap
#  ^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#          ^^ source.liquidsoap
#            ^ source.liquidsoap
#             ^^ source.liquidsoap keyword.control.liquidsoap
#               ^ source.liquidsoap
#                ^^^^^^^^^^^^^^^^ source.liquidsoap variable.liquidsoap
#                                ^ source.liquidsoap
#                                 ^^^^ source.liquidsoap keyword.control.liquidsoap
#                                     ^ source.liquidsoap
#                                      ^^^ source.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                                         ^ source.liquidsoap
#                                          ^ source.liquidsoap variable.liquidsoap
#                                           ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                            ^ source.liquidsoap variable.liquidsoap
#                                             ^ source.liquidsoap
#                                              ^ source.liquidsoap
#                                               ^^ source.liquidsoap keyword.control.function.declaration.liquidsoap
#                                                 ^ source.liquidsoap
#                                                  ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                       ^ source.liquidsoap meta.function-call.liquidsoap
#                                                        ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                                               ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                ^^^^^ source.liquidsoap meta.function-call.liquidsoap constant.language.boolean.liquidsoap
#                                                                     ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                      ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                       ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                         ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                            ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                       ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                                         ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                                          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap keyword.operator.arithmetic.liquidsoap
#                                                                                           ^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap constant.numeric.decimal.integer.liquidsoap
#                                                                                              ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap keyword.operator.arithmetic.liquidsoap
#                                                                                               ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                                                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                                                 ^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                                     ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap constant.character.escape.liquidsoap
#                                                                                                       ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                                        ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                                                         ^ source.liquidsoap
#                                                                                                          ^^^^ source.liquidsoap keyword.control.liquidsoap
#                                                                                                              ^ source.liquidsoap
#                                                                                                               ^^^ source.liquidsoap keyword.other.function.definition.anonymous.liquidsoap
#                                                                                                                  ^ source.liquidsoap
#                                                                                                                   ^ source.liquidsoap variable.liquidsoap
#                                                                                                                    ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                                                                     ^ source.liquidsoap variable.liquidsoap
#                                                                                                                      ^ source.liquidsoap
#                                                                                                                       ^ source.liquidsoap
#                                                                                                                        ^^ source.liquidsoap keyword.control.function.declaration.liquidsoap
#                                                                                                                          ^^^^ source.liquidsoap
#                                                                                                                              ^^^ source.liquidsoap keyword.control.liquidsoap
>  scan(progress=progress)
#^^ source.liquidsoap
#  ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#      ^ source.liquidsoap meta.function-call.liquidsoap
#       ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap
>  log.important(label=id,"Scanned new files in #{dt(t)}s: #{list.length(db())} entries")
#^^ source.liquidsoap
#  ^^^ source.liquidsoap variable.liquidsoap
#     ^ source.liquidsoap meta.function-call.liquidsoap
#      ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                         ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                          ^^^^^^^^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                               ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                 ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                   ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                    ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                     ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                      ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                       ^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                          ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                            ^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap variable.liquidsoap
#                                                                ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                 ^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                       ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                        ^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                                          ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                           ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                            ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap meta.function-call.liquidsoap
#                                                                             ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap string.interpolation.liquidsoap
#                                                                              ^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                      ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                                                                       ^ source.liquidsoap meta.function-call.liquidsoap
>  store()
#^^ source.liquidsoap
#  ^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#       ^ source.liquidsoap meta.function-call.liquidsoap
#        ^ source.liquidsoap meta.function-call.liquidsoap
>  log.important(label=id,"Stored library")
#^^ source.liquidsoap
#  ^^^ source.liquidsoap variable.liquidsoap
#     ^ source.liquidsoap meta.function-call.liquidsoap
#      ^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#               ^ source.liquidsoap meta.function-call.liquidsoap
#                ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                     ^ source.liquidsoap meta.function-call.liquidsoap
#                      ^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                        ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                         ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                          ^^^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                        ^ source.liquidsoap meta.function-call.liquidsoap string.quoted.double.liquidsoap
#                                         ^ source.liquidsoap meta.function-call.liquidsoap
>
>  if null.defined(refresh_time) then
#^^ source.liquidsoap
#  ^^ source.liquidsoap keyword.control.liquidsoap
#    ^ source.liquidsoap
#     ^^^^ source.liquidsoap variable.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
#          ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                 ^ source.liquidsoap meta.function-call.liquidsoap
#                  ^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                              ^ source.liquidsoap meta.function-call.liquidsoap
#                               ^ source.liquidsoap
#                                ^^^^ source.liquidsoap keyword.control.liquidsoap
>    thread.run(delay=null.get(refresh_time), every=null.get(refresh_time), refresh)
#^^^^ source.liquidsoap
#    ^^^^^^ source.liquidsoap variable.liquidsoap
#          ^ source.liquidsoap meta.function-call.liquidsoap
#           ^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#              ^ source.liquidsoap meta.function-call.liquidsoap
#               ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                    ^ source.liquidsoap meta.function-call.liquidsoap
#                     ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                         ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                          ^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                             ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                              ^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                          ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                           ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                            ^ source.liquidsoap meta.function-call.liquidsoap
#                                             ^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.language.arguments.named.liquidsoap
#                                                  ^ source.liquidsoap meta.function-call.liquidsoap
#                                                   ^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                       ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                        ^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                                           ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                            ^^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                        ^ source.liquidsoap meta.function-call.liquidsoap meta.function-call.liquidsoap
#                                                                         ^ source.liquidsoap meta.function-call.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                          ^ source.liquidsoap meta.function-call.liquidsoap
#                                                                           ^^^^^^^ source.liquidsoap meta.function-call.liquidsoap variable.liquidsoap
#                                                                                  ^ source.liquidsoap meta.function-call.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.control.liquidsoap
>
>  def clear()
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#           ^ source.liquidsoap
#            ^ source.liquidsoap
>    db := []
#^^^^ source.liquidsoap
#    ^^ source.liquidsoap variable.liquidsoap
#      ^ source.liquidsoap
#       ^^ source.liquidsoap keyword.operator.set.liquidsoap
#         ^^^^ source.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  def add_directory(d)
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.definition.liquidsoap
#     ^ source.liquidsoap
#      ^^^^^^^^^^^^^ source.liquidsoap entity.name.function.binding.liquidsoap
#                   ^ source.liquidsoap
#                    ^ source.liquidsoap variable.liquidsoap
#                     ^ source.liquidsoap
>    directories := d :: directories()
#^^^^ source.liquidsoap
#    ^^^^^^^^^^^ source.liquidsoap variable.liquidsoap
#               ^ source.liquidsoap
#                ^^ source.liquidsoap keyword.operator.set.liquidsoap
#                  ^ source.liquidsoap
#                   ^ source.liquidsoap variable.liquidsoap
#                    ^ source.liquidsoap
#                     ^^ source.liquidsoap keyword.operator.append.liquidsoap
#                       ^ source.liquidsoap
#                        ^^^^^^^^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#                                   ^ source.liquidsoap meta.function-call.liquidsoap
#                                    ^ source.liquidsoap meta.function-call.liquidsoap
>    scan()
#^^^^ source.liquidsoap
#    ^^^^ source.liquidsoap meta.function-call.liquidsoap entity.name.function.liquidsoap
#        ^ source.liquidsoap meta.function-call.liquidsoap
#         ^ source.liquidsoap meta.function-call.liquidsoap
>  end
#^^ source.liquidsoap
#  ^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>
>  {find = find, refresh = refresh, add_directory = add_directory, clear = clear}
#^^ source.liquidsoap
#  ^ source.liquidsoap
#   ^^^^ source.liquidsoap entity.name.method.liquidsoap
#       ^^ source.liquidsoap
#         ^ source.liquidsoap
#          ^^^^ source.liquidsoap variable.liquidsoap
#              ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#               ^ source.liquidsoap
#                ^^^^^^^ source.liquidsoap entity.name.method.liquidsoap
#                       ^^ source.liquidsoap
#                         ^ source.liquidsoap
#                          ^^^^^^^ source.liquidsoap variable.liquidsoap
#                                 ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                  ^ source.liquidsoap
#                                   ^^^^^^^^^^^^^ source.liquidsoap entity.name.method.liquidsoap
#                                                ^^ source.liquidsoap
#                                                  ^ source.liquidsoap
#                                                   ^^^^^^^^^^^^^ source.liquidsoap variable.liquidsoap
#                                                                ^ source.liquidsoap keyword.other.liquidsoap punctuation.comma punctuation.separator.comma
#                                                                 ^ source.liquidsoap
#                                                                  ^^^^^ source.liquidsoap entity.name.method.liquidsoap
#                                                                       ^^ source.liquidsoap
#                                                                         ^ source.liquidsoap
#                                                                          ^^^^^ source.liquidsoap variable.liquidsoap
#                                                                               ^ source.liquidsoap
>end
#^^^ source.liquidsoap keyword.other.function.end.liquidsoap
>